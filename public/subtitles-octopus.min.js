"use strict";var SubtitlesOctopus=function(e){var t,r=!1;try{"object"!=typeof WebAssembly||"function"!=typeof WebAssembly.instantiate||(t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0)))instanceof WebAssembly.Module&&(r=new WebAssembly.Instance(t)instanceof WebAssembly.Instance)}catch(e){}console.log("WebAssembly support detected: "+(r?"yes":"no"));var l=this;function a(){l.setCurrentTime(l.video.currentTime+l.timeOffset)}function n(){l.setIsPaused(!1,l.video.currentTime+l.timeOffset)}function o(){l.setIsPaused(!0,l.video.currentTime+l.timeOffset)}function s(){l.video.removeEventListener("timeupdate",a,!1)}function i(){l.video.addEventListener("timeupdate",a,!1);var e=l.video.currentTime+l.timeOffset;l.setCurrentTime(e)}function c(){l.setRate(l.video.playbackRate)}function d(){l.setIsPaused(!0,l.video.currentTime+l.timeOffset)}function v(e){e.target.removeEventListener(e.type,v,!1),l.resize()}function u(){var e=l.renderFramesData,t=performance.now();l.ctx.clearRect(0,0,l.canvas.width,l.canvas.height);for(var r,a=0;a<e.canvases.length;a++){var n=e.canvases[a],o=(l.bufferCanvas.width=n.w,l.bufferCanvas.height=n.h,new Uint8ClampedArray(n.buffer));if(l.hasAlphaBug)for(var s=3;s<o.length;s+=4)o[s]=1<=o[s]?o[s]:1;var i=new ImageData(o,n.w,n.h);l.bufferCanvasCtx.putImageData(i,0,0),l.ctx.drawImage(l.bufferCanvas,n.x,n.y)}l.debug&&(t=Math.round(performance.now()-t),void 0!==(r=e.blendTime)?console.log("render: "+Math.round(e.spentTime-r)+" ms, blend: "+Math.round(r)+" ms, draw: "+t+" ms; TOTAL="+Math.round(e.spentTime+t)+" ms"):console.log(Math.round(e.spentTime)+" ms (+ "+t+" ms draw)"),l.renderStart=performance.now())}function m(){var e=l.renderFramesData,t=performance.now();l.ctx.clearRect(0,0,l.canvas.width,l.canvas.height);for(var r=0;r<e.bitmaps.length;r++){var a=e.bitmaps[r];l.ctx.drawImage(a.bitmap,a.x,a.y)}l.debug&&(t=Math.round(performance.now()-t),console.log(e.bitmaps.length+" bitmaps, libass: "+Math.round(e.libassTime)+"ms, decode: "+Math.round(e.decodeTime)+"ms, draw: "+t+"ms"),l.renderStart=performance.now())}l.canvas=e.canvas,l.renderMode=e.renderMode||(e.lossyRender?"lossy":"wasm-blend"),l.libassMemoryLimit=e.libassMemoryLimit||0,l.libassGlyphLimit=e.libassGlyphLimit||0,l.targetFps=e.targetFps||24,l.prescaleFactor=e.prescaleFactor||1,l.prescaleHeightLimit=e.prescaleHeightLimit||1080,l.maxRenderHeight=e.maxRenderHeight||0,l.dropAllAnimations=e.dropAllAnimations||!1,l.isOurCanvas=!1,l.video=e.video,l.canvasParent=null,l.fonts=e.fonts||[],l.availableFonts=e.availableFonts||[],l.fallbackFont=e.fallbackFont||"default.woff2",l.lazyFileLoading=e.lazyFileLoading||!1,l.onReadyEvent=e.onReady,l.workerUrl=r?e.workerUrl||"subtitles-octopus-worker.js":e.legacyWorkerUrl||"subtitles-octopus-worker-legacy.js",l.subUrl=e.subUrl,l.subContent=e.subContent||null,l.onErrorEvent=e.onError,l.debug=e.debug||!1,l.lastRenderTime=0,l.pixelRatio=window.devicePixelRatio||1,l.timeOffset=e.timeOffset||0,l.hasAlphaBug=!1,function(){if("function"==typeof ImageData.prototype.constructor)try{return new window.ImageData(new Uint8ClampedArray([0,0,0,0]),1,1)}catch(e){console.log("detected that ImageData is not constructable despite browser saying so")}var a=document.createElement("canvas").getContext("2d");window.ImageData=function(){var e,t=0,r=(arguments[0]instanceof Uint8ClampedArray&&(e=arguments[t++]),arguments[t++]),r=a.createImageData(r,arguments[t]);return e&&r.data.set(e),r}}(),l.workerError=function(e){if(console.error("Worker error: ",e),l.onErrorEvent&&l.onErrorEvent(e),!l.debug)throw l.dispose(),new Error("Worker error: "+e)},l.init=function(){window.Worker?(l.worker||(l.worker=new Worker(l.workerUrl),l.worker.addEventListener("message",l.onWorkerMessage),l.worker.addEventListener("error",l.workerError)),l.workerActive=!1,l.createCanvas(),l.setVideo(e.video),l.setSubUrl(e.subUrl),l.worker.postMessage({target:"worker-init",width:l.canvas.width,height:l.canvas.height,URL:document.URL,currentScript:l.workerUrl,preMain:!0,renderMode:l.renderMode,subUrl:l.subUrl,subContent:l.subContent,fonts:l.fonts,availableFonts:l.availableFonts,fallbackFont:l.fallbackFont,lazyFileLoading:l.lazyFileLoading,debug:l.debug,targetFps:l.targetFps,libassMemoryLimit:l.libassMemoryLimit,libassGlyphLimit:l.libassGlyphLimit,dropAllAnimations:l.dropAllAnimations})):l.workerError("worker not supported")},l.createCanvas=function(){l.canvas||(l.video?(l.isOurCanvas=!0,l.canvas=document.createElement("canvas"),l.canvas.className="libassjs-canvas",l.canvas.style.display="none",l.canvasParent=document.createElement("div"),l.canvasParent.className="libassjs-canvas-parent",l.canvasParent.appendChild(l.canvas),l.video.nextSibling?l.video.parentNode.insertBefore(l.canvasParent,l.video.nextSibling):l.video.parentNode.appendChild(l.canvasParent)):l.canvas||l.workerError("Don't know where to render: you should give video or canvas in options.")),l.ctx=l.canvas.getContext("2d"),l.bufferCanvas=document.createElement("canvas"),l.bufferCanvasCtx=l.bufferCanvas.getContext("2d"),l.bufferCanvas.width=1,l.bufferCanvas.height=1;var e=new Uint8ClampedArray([0,255,0,0]),e=new ImageData(e,1,1),t=(l.bufferCanvasCtx.clearRect(0,0,1,1),l.ctx.clearRect(0,0,1,1),l.ctx.getImageData(0,0,1,1).data),e=(l.bufferCanvasCtx.putImageData(e,0,0),l.ctx.drawImage(l.bufferCanvas,0,0),l.ctx.getImageData(0,0,1,1).data);l.hasAlphaBug=t[1]!=e[1],l.hasAlphaBug&&console.log("Detected a browser having issue with transparent pixels, applying workaround")},l.setVideo=function(e){l.video=e,l.video&&(l.video.addEventListener("timeupdate",a,!1),l.video.addEventListener("playing",n,!1),l.video.addEventListener("pause",o,!1),l.video.addEventListener("seeking",s,!1),l.video.addEventListener("seeked",i,!1),l.video.addEventListener("ratechange",c,!1),l.video.addEventListener("waiting",d,!1),document.addEventListener("fullscreenchange",l.resizeWithTimeout,!1),document.addEventListener("mozfullscreenchange",l.resizeWithTimeout,!1),document.addEventListener("webkitfullscreenchange",l.resizeWithTimeout,!1),document.addEventListener("msfullscreenchange",l.resizeWithTimeout,!1),window.addEventListener("resize",l.resizeWithTimeout,!1),"undefined"!=typeof ResizeObserver&&(l.ro=new ResizeObserver(l.resizeWithTimeout),l.ro.observe(l.video)),0<l.video.videoWidth?l.resize():l.video.addEventListener("loadedmetadata",v,!1))},l.getVideoPosition=function(){var e=l.video.videoWidth/l.video.videoHeight,t=l.video.offsetWidth,r=l.video.offsetHeight,a=t,n=r,e=(e<t/r?a=Math.floor(r*e):n=Math.floor(t/e),(t-a)/2);return{width:a,height:n,x:e,y:(r-n)/2}},l.setSubUrl=function(e){l.subUrl=e},l.renderFrameData=null,l.workerActive=!1,l.frameId=0,l.onWorkerMessage=function(e){l.workerActive||(l.workerActive=!0,l.onReadyEvent&&l.onReadyEvent());var t=e.data;switch(t.target){case"stdout":console.log(t.content);break;case"console-log":console.log.apply(console,JSON.parse(t.content));break;case"console-debug":console.debug.apply(console,JSON.parse(t.content));break;case"console-info":console.info.apply(console,JSON.parse(t.content));break;case"console-warn":console.warn.apply(console,JSON.parse(t.content));break;case"console-error":console.error.apply(console,JSON.parse(t.content));break;case"stderr":console.error(t.content);break;case"window":window[t.method]();break;case"canvas":switch(t.op){case"getContext":l.ctx=l.canvas.getContext(t.type,t.attributes);break;case"resize":l.resize(t.width,t.height);break;case"renderCanvas":l.lastRenderTime<t.time&&(l.lastRenderTime=t.time,l.renderFramesData=t,window.requestAnimationFrame(u));break;case"renderFastCanvas":l.lastRenderTime<t.time&&(l.lastRenderTime=t.time,l.renderFramesData=t,window.requestAnimationFrame(m));break;case"setObjectProperty":l.canvas[t.object][t.property]=t.value;break;default:throw"eh?"}break;case"tick":l.frameId=t.id,l.worker.postMessage({target:"tock",id:l.frameId});break;case"custom":if(!l.onCustomMessage)throw"Custom message received but client onCustomMessage not implemented.";l.onCustomMessage(e);break;case"setimmediate":l.worker.postMessage({target:"setimmediate"});break;case"get-events":case"get-styles":case"ready":break;default:throw"what? "+t.target}},l.resize=function(e,t,r,a){var n,o,s,i,c,d=null;r=r||0,a=a||0,e&&t||!l.video||(d=l.getVideoPosition(),n=d.width*l.pixelRatio,o=d.height*l.pixelRatio,c=l.prescaleFactor<=0?1:l.prescaleFactor,o=o<=0||n<=0?n=0:((s=c<1?-1:1)*(i=o)*c<=s*l.prescaleHeightLimit?i*=c:s*i<s*l.prescaleHeightLimit&&(i=l.prescaleHeightLimit),n*=(i=0<l.maxRenderHeight&&i>l.maxRenderHeight?l.maxRenderHeight:i)/o,i),e=(c={width:n,height:o}).width,t=c.height,s=l.canvasParent.getBoundingClientRect().top-l.video.getBoundingClientRect().top,r=d.y-s,a=d.x),e&&t?l.canvas.width==e&&l.canvas.height==t&&l.canvas.style.top==r&&l.canvas.style.left==a||(l.canvas.width=e,l.canvas.height=t,null!=d&&(l.canvasParent.style.position="relative",l.canvas.style.display="block",l.canvas.style.position="absolute",l.canvas.style.width=d.width+"px",l.canvas.style.height=d.height+"px",l.canvas.style.top=r+"px",l.canvas.style.left=a+"px",l.canvas.style.pointerEvents="none"),l.worker.postMessage({target:"canvas",width:l.canvas.width,height:l.canvas.height})):l.video||console.error("width or height is 0. You should specify width & height for resize.")},l.resizeWithTimeout=function(){l.resize(),setTimeout(l.resize,100)},l.runBenchmark=function(){l.worker.postMessage({target:"runBenchmark"})},l.customMessage=function(e,t){l.worker.postMessage({target:"custom",userData:e,preMain:(t=t||{}).preMain})},l.setCurrentTime=function(e){l.worker.postMessage({target:"video",currentTime:e})},l.setTrackByUrl=function(e){l.worker.postMessage({target:"set-track-by-url",url:e})},l.setTrack=function(e){l.worker.postMessage({target:"set-track",content:e})},l.freeTrack=function(e){l.worker.postMessage({target:"free-track"})},l.render=l.setCurrentTime,l.setIsPaused=function(e,t){l.worker.postMessage({target:"video",isPaused:e,currentTime:t})},l.setRate=function(e){l.worker.postMessage({target:"video",rate:e})},l.dispose=function(){l.worker.postMessage({target:"destroy"}),l.worker.terminate(),l.worker.removeEventListener("message",l.onWorkerMessage),l.worker.removeEventListener("error",l.workerError),l.workerActive=!1,l.worker=null,l.video&&(l.video.removeEventListener("timeupdate",a,!1),l.video.removeEventListener("playing",n,!1),l.video.removeEventListener("pause",o,!1),l.video.removeEventListener("seeking",s,!1),l.video.removeEventListener("seeked",i,!1),l.video.removeEventListener("ratechange",c,!1),l.video.removeEventListener("waiting",d,!1),l.video.removeEventListener("loadedmetadata",v,!1),document.removeEventListener("fullscreenchange",l.resizeWithTimeout,!1),document.removeEventListener("mozfullscreenchange",l.resizeWithTimeout,!1),document.removeEventListener("webkitfullscreenchange",l.resizeWithTimeout,!1),document.removeEventListener("msfullscreenchange",l.resizeWithTimeout,!1),window.removeEventListener("resize",l.resizeWithTimeout,!1),l.video.parentNode.removeChild(l.canvasParent),l.video=null),l.ro&&(l.ro.disconnect(),l.ro=null),l.onCustomMessage=null,l.onErrorEvent=null,l.onReadyEvent=null},l.fetchFromWorker=function(e,t,r){try{var a=e.target,n=setTimeout(function(){s(Error("Error: Timeout while try to fetch "+a))},5e3),o=function(e){e.data.target==a&&(t(e.data),l.worker.removeEventListener("message",o),l.worker.removeEventListener("error",s),clearTimeout(n))},s=function(e){r(e),l.worker.removeEventListener("message",o),l.worker.removeEventListener("error",s),clearTimeout(n)};l.worker.addEventListener("message",o),l.worker.addEventListener("error",s),l.worker.postMessage(e)}catch(e){r(e)}},l.createEvent=function(e){l.worker.postMessage({target:"create-event",event:e})},l.getEvents=function(t,e){l.fetchFromWorker({target:"get-events"},function(e){t(e.events)},e)},l.setEvent=function(e,t){l.worker.postMessage({target:"set-event",event:e,index:t})},l.removeEvent=function(e){l.worker.postMessage({target:"remove-event",index:e})},l.createStyle=function(e){l.worker.postMessage({target:"create-style",style:e})},l.getStyles=function(t,e){l.fetchFromWorker({target:"get-styles"},function(e){t(e.styles)},e)},l.setStyle=function(e,t){l.worker.postMessage({target:"set-style",style:e,index:t})},l.removeStyle=function(e){l.worker.postMessage({target:"remove-style",index:e})},l.init()};"function"==typeof SubtitlesOctopusOnLoad&&SubtitlesOctopusOnLoad(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=SubtitlesOctopus);